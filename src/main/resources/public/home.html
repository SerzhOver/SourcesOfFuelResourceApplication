<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
>
<head>
    <title>Home page</title>
    <link rel="stylesheet" type="text/css" href="css/home.css">
</head>
<body>
<div id="googleMap" style="height: 100%"></div>

<div id="listing">
    <table id="resultsTable">
        <tbody id="results"></tbody>
    </table>
</div>

<div style="display: none">
    <div id="info-content">
        <table>
            <tr id="iw-url-row" class="iw_table_row">
                <td id="iw-icon" class="iw_table_icon"></td>
                <td id="iw-url"></td>
            </tr>
            <tr id="iw-address-row" class="iw_table_row">
                <td class="iw_attribute_name">Address:</td>
                <td id="iw-address"></td>
            </tr>
            <tr id="iw-phone-row" class="iw_table_row">
                <td class="iw_attribute_name">Telephone:</td>
                <td id="iw-phone"></td>
            </tr>
            <tr id="iw-rating-row" class="iw_table_row">
                <td class="iw_attribute_name">Rating:</td>
                <td id="iw-rating"></td>
            </tr>
            <tr id="iw-website-row" class="iw_table_row">
                <td class="iw_attribute_name">Website:</td>
                <td id="iw-website"></td>
            </tr>
        </table>
    </div>
</div>
<script>
    let map, infoWindow;

    function myMap() {
        var pyrmont = new google.maps.LatLng(50.4477313, 30.542721);

        map = new google.maps.Map(document.getElementById('googleMap'), {
            center: pyrmont,
            zoom: 10
        });
        infoWindow = new google.maps.InfoWindow();


        const locationButton = document.createElement("button");

        locationButton.textContent = "Відобразити моє місцезнаходження";
        locationButton.classList.add("custom-map-control-button");
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
        locationButton.addEventListener("click", () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };

                        infoWindow.setPosition(pos);
                        infoWindow.setContent("Моє місцеположення.");
                        infoWindow.open(map);
                        map.setCenter(pos);
                        var service = new google.maps.places.PlacesService(map);
                        service.nearbySearch({
                            location: new google.maps.LatLng(pos.lat, pos.lng),
                            radius: 5000,
                            type: ['gas_station']
                        }, callback);
                    },
                    () => {
                        handleLocationError(true, infoWindow, map.getCenter());
                    }
                );
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }


        });
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(
            browserHasGeolocation
                ? "Error: The Geolocation service failed."
                : "Error: Your browser doesn't support geolocation."
        );
        infoWindow.open(map);
    }


    function callback(results, status) {
        var stationName = ['Ukrnafta' , 'WOG', 'ОККО' , 'AMIC' , 'Avias' , 'SOCAR' ]
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            for (var i = 0; i < results.length; i++) {
                let strings = stationName.filter(name => JSON.stringify(results[i]).toString().includes(name));

                if (JSON.stringify(results[i]).toString().includes('OPERATIONAL') && strings.length !== 0) {
                    console.log(JSON.stringify(results[i]))
                    createMarker(results[i]);
                }
            }
        }
    }

    function createMarker(place) {
        var placeLoc = place.geometry.location;
        var marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location
        });

        google.maps.event.addListener(marker, 'click', function () {
            infowindow.setContent(place.name);
            infowindow.open(map, this);
        });
    }
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCamscMCTgxzNuNz-5lHfQs4VOGgi35ow0&libraries=places&callback=myMap"></script>
</body>
</html>