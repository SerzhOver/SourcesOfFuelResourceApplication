<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns="http://www.w3.org/1999/xhtml"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5" lang="en">
<head>
    <title>Home page</title>
    <link rel="stylesheet" type="text/css" href="css/home.css">
</head>
<body>
<div sec:authorize="isAuthenticated()">
    This content is only shown to authenticated users.
</div>
<div id="googleMap" style="height: 100%"></div>
<script>
    let map, infoWindow, currentPosition;

    function myMap() {
        var pyrmont = new google.maps.LatLng(50.4477313, 30.542721);

        map = new google.maps.Map(document.getElementById('googleMap'), {
            center: pyrmont,
            zoom: 10
        });
        infoWindow = new google.maps.InfoWindow();

        const locationButton = document.createElement("button");
        const buyTicket = document.createElement("button");

        buyTicket.textContent="Перейти до купівлі купонів";
        buyTicket.classList.add("custom-map-control-button");
        buyTicket.addEventListener("click", () => {
            window.location.href ='http://localhost:8080/pay';
        });

        locationButton.textContent = "Відобразити моє місцезнаходження";
        locationButton.classList.add("custom-map-control-button");
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(buyTicket);
        map.controls[google.maps.ControlPosition.TOP_CENTER].push(locationButton);
        locationButton.addEventListener("click", () => {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const pos = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        };
                        var marker = new google.maps.Marker({
                            map: map,
                            position: pos
                        });

                        currentPosition = pos;
                        infoWindow.setPosition(pos);
                        infoWindow.setContent("Моє місцезнаходження.");
                        map.setCenter(pos);
                        var service = new google.maps.places.PlacesService(map);
                        service.nearbySearch({
                            location: new google.maps.LatLng(pos.lat, pos.lng),
                            radius: 5000,
                            type: ['gas_station']
                        }, callback);
                    },
                    () => {
                        handleLocationError(true, infoWindow, map.getCenter());
                    }
                );
            } else {
                // Browser doesn't support Geolocation
                handleLocationError(false, infoWindow, map.getCenter());
            }


        });
    }

    function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(
            browserHasGeolocation
                ? "Error: The Geolocation service failed."
                : "Error: Your browser doesn't support geolocation."
        );
        infoWindow.open(map);
    }


    function callback(results, status) {
        const stationName = ['Ukrnafta', 'WOG', 'ОККО', 'AMIC', 'Avias', 'SOCAR', 'KLO', 'Shell', 'Glusco'];
        if (status === google.maps.places.PlacesServiceStatus.OK) {
            for (let i = 0; i < results.length; i++) {
                let strings = stationName.filter(name => JSON.stringify(results[i]).toString().includes(name));

                if (JSON.stringify(results[i]).toString().includes('OPERATIONAL') && strings.length !== 0) {
                    createMarker(results[i]);
                }
            }
        }
    }

    function createMarker(place) {
        const image = "http://maps.google.com/mapfiles/ms/icons/gas.png"
        var placeLoc = place.geometry.location;
        var marker = new google.maps.Marker({
            map: map,
            position: place.geometry.location,
            icon: image
        });
        marker.setMap(map);

        google.maps.event.addListener(marker, 'click', function () {
            let ratingHtml = "";
            let distance = "";
            let duration = "";
            const service = new google.maps.DistanceMatrixService();
            const request = {
                origins: [currentPosition],
                destinations: [placeLoc],
                travelMode: google.maps.TravelMode.DRIVING,
                unitSystem: google.maps.UnitSystem.METRIC,
                avoidHighways: false,
                avoidTolls: false,
            };

            service.getDistanceMatrix(request).then((response) => {

                distance = response.rows[0].elements[0].distance.text;
                duration = response.rows[0].elements[0].duration.text;

                for (let i = 0; i < 5; i++) {
                    if (place.rating < i + 0.5) {
                        ratingHtml += "&#10025;";
                    } else {
                        ratingHtml += "&#10029;";
                    }
                }

                let name = place.name
                let floor = ["", "", "", "", ""];

                for (let i = 0; i < floor.length; i++) {
                    let randomValue = Math.floor(Math.random() * 10);
                    if (randomValue < 6) { // 0 ,1 , 2 ,3,4,5
                        floor[i] = "&#128994 Достатньо"
                    } else if (randomValue < 9 && randomValue >= 6) { //   6, 7, 8
                        floor[i] = "&#128993 Мало на залишку";
                    } else { //  9
                        floor[i] = "&#128308 Відсутній";
                    }
                }

                if (name.toString().includes('Ukrnafta')) {
                    name = "Укрнафта"
                }

                let urlLoc = "https://www.google.com/maps/dir/" + currentPosition.lat + "," + currentPosition.lng +
                    "/" + placeLoc.lat() + "," + placeLoc.lng() + "/data=!3m1!4b1!4m2!4m1!3e0";
                const content = 'Назва: ' + name + '<br \/>' +
                    'Адреса: ' + place.vicinity + '<br \/>' +
                    'Рейтинг: ' + ratingHtml + '<br \/>' +
                    'Відстань:' + distance + '<br \/>' +
                    'Тривалість маршрута:' + duration + '<br \/>' +
                    'А-92: ' + floor[0] + '<br \/>' +
                    'А-95: ' + floor[1] + '<br \/>' +
                    'A-95+: ' + floor[2] + '<br \/>' +
                    'ДП: ' + floor[3] + '<br \/>' +
                    'Газ: ' + floor[4] + '<br \/>' +
                    'Відобразити маршрут до станції' + '<a href="' + urlLoc + '" > Показати маршрут </a>';


                infoWindow.setContent(content);
                infoWindow.open(map, marker);
            });
        });
    }

</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCamscMCTgxzNuNz-5lHfQs4VOGgi35ow0&libraries=places&callback=myMap"
        defer></script>
</body>
</html>